<main class="bises-page">
  <section class="top-panel">
    <div class="panel-title">
      <h1>BiS Atlas</h1>
      <p>Explore best-in-slot sources by instance, boss, specialization and slot.</p>
    </div>

    <div class="filters-grid">
      <select name="Instances" id="instances" (change)="filtrar(0, $event)">
        <option value="">Location</option>
        <option [value]="instance" *ngFor="let instance of instancesLibrary">{{instance}}</option>
      </select>

      <select *ngIf="encounterFlag != -1" name="Bosses" id="bosses" (change)="filtrar(1, $event)">
        <option *ngIf="encounterFlag == 0" value="">Bosses</option>
        <option *ngIf="encounterFlag == 1" value="">Dungeons</option>
        <option [value]="boss" *ngFor="let boss of encounterLibrary[encounterFlag]">{{boss}}</option>
      </select>

      <select name="Specs" id="specs" (change)="filtrar(2, $event)">
        <option value="">Specs</option>
        <option [value]="spec" *ngFor="let spec of specsLibrary">{{spec}}</option>
      </select>

      <select name="Slots" id="slots" (change)="filtrar(3, $event)">
        <option value="">Slots</option>
        <option [value]="i" *ngFor="let slot of slotsLibrary; let i = index">{{formatSlotLabel(slot)}}</option>
      </select>
    </div>

    <div class="actions-row">
      <ng-container *ngIf="isAdminConfigEnabled; else adminConfigEntry">
        <button
          class="btn ghost"
          [title]="canReloadBisFromCurrentRuntime ? 'Recargar BiS desde Wowhead' : 'No disponible sin backend/proxy de scraping'"
          [disabled]="!canReloadBisFromCurrentRuntime"
          (click)="reloadBisFromWowhead()"
        >â†»</button>
        <button class="btn ghost" title="Cachear items faltantes en Blizzard API" (click)="cacheMissingItems()">ðŸ—„</button>
        <button class="btn ghost danger" title="Limpiar cache de items" (click)="clearItemCache()">ðŸ—‘</button>
      </ng-container>
      <ng-template #adminConfigEntry>
        <button class="btn ghost" title="ConfiguraciÃ³n admin" (click)="openAdminModal()">âš™</button>
      </ng-template>
      <button
        class="btn ghost"
        *ngIf="selectedSpec && getSelectedSpecWowheadUrl()"
        title="Abrir BiS de esta spec en Wowhead"
        (click)="openSelectedSpecWowhead()"
      >ðŸ”—</button>
      <button class="btn ghost" *ngIf="tableBisList != tableBisList_full" (click)="resetFiltros()">Reset</button>
      <button class="btn primary" (click)="goMain()">Main</button>
    </div>
  </section>

  <section class="tier-breaks" *ngIf="!isLoading && tierBreakGroups.length > 0 && !hasActiveFilters()">
    <div class="tier-head">
      <h2>Tier Breaks</h2>
      <p>Each spec runs 4/5 tier pieces. Marked slot (`X`) is the break piece.</p>
    </div>

    <div class="tier-groups">
      <article class="tier-group-card" *ngFor="let group of tierBreakGroups">
        <h3>{{ group.armorType }}</h3>
        <div class="tier-spec-row" *ngFor="let row of group.specs">
          <div class="tier-spec-name" [ngStyle]="{'color': generateColor(row.spec)}">{{ row.spec }}</div>
          <div class="tier-slot-track">
            <div
              class="tier-slot"
              *ngFor="let slot of tierSlots"
              [class.break]="slot === row.breakSlot"
              [title]="tierSlotVisuals[slot].label + (slot === row.breakSlot ? ' (Break)' : ' (Tier)')"
            >
              <span class="slot-icon">{{ tierSlotVisuals[slot].icon }}</span>
              <span class="slot-x" *ngIf="slot === row.breakSlot">X</span>
            </div>
          </div>
        </div>
      </article>
    </div>
  </section>

  <section class="items-grid" *ngIf="!isLoading">
    <article *ngFor="let item of tableBisList" class="bis-card">
      <img *ngIf="item.img" [src]="item.img" alt="Item Image">
      <div class="item-content">
        <h3>{{capitalizeFirstLetter(item.name)}}</h3>
        <p>{{ item.boss ? item.boss : item.instance }}</p>
        <div class="spec-tags">
          <span *ngFor="let spec of item.spec" [ngStyle]="{'color': generateColor(spec)}">{{spec}}</span>
        </div>
      </div>
    </article>
  </section>

  <div *ngIf="isLoading" class="loading-message">
    <p>Procesando...</p>
  </div>

  <div class="modal-backdrop" *ngIf="showAdminModal" (click)="closeAdminModal()">
    <section class="modal-card" (click)="$event.stopPropagation()">
      <h3>Acceso Admin</h3>
      <p>Introduce password para activar configuraciÃ³n.</p>
      <input
        type="password"
        [(ngModel)]="adminPasswordInput"
        (keydown.enter)="submitAdminPassword()"
        placeholder="Password"
      >
      <p class="modal-error" *ngIf="adminPasswordError">{{ adminPasswordError }}</p>
      <div class="modal-actions">
        <button class="btn ghost" (click)="closeAdminModal()">Cancelar</button>
        <button class="btn primary" (click)="submitAdminPassword()">Entrar</button>
      </div>
    </section>
  </div>
</main>
